<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matching EIR to *Pf*PR~2-10~ â€¢ malariasimulation</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Matching EIR to *Pf*PR~2-10~">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">malariasimulation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Model.html">Model Introduction</a>
    </li>
    <li>
      <a href="../articles/Demography.html">Demography</a>
    </li>
    <li>
      <a href="../articles/Treatment.html">Treatment</a>
    </li>
    <li>
      <a href="../articles/MDA.html">MDA and Chemoprevention</a>
    </li>
    <li>
      <a href="../articles/Vaccines.html">Vaccines</a>
    </li>
    <li>
      <a href="../articles/VectorControl_Bednets.html">Vector Control: Bednets</a>
    </li>
    <li>
      <a href="../articles/VectorControl_IRS.html">Vector Control: Indoor Residual Spraying</a>
    </li>
    <li>
      <a href="../articles/SetSpecies.html">Mosquito Species</a>
    </li>
    <li>
      <a href="../articles/Carrying-capacity.html">Carrying Capacity</a>
    </li>
    <li>
      <a href="../articles/EIRprevmatch.html">Matching PfPR2-10 to EIR</a>
    </li>
    <li>
      <a href="../articles/Metapopulation.html">Metapopulation Modelling</a>
    </li>
    <li>
      <a href="../articles/Variation.html">Stochastic Variation</a>
    </li>
    <li>
      <a href="../articles/Parameter_variation.html">Parameter Variation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/malariasimulation" class="external-link">
    <span class="fa fa-github"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Matching EIR to
<em>Pf</em>PR<sub>2-10</sub>
</h1>
            
      

      <div class="hidden name"><code>EIRprevmatch.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the requisite packages:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">malariasimulation</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">malariaEquilibrium</span><span class="op">)</span></span>
<span><span class="co"># Set colour palette:</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>,<span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span><span class="op">)</span></span></code></pre></div>
<p>The entomological inoculation rate (EIR), defined as the number of
infectious bites experienced per person per unit time, and malaria
prevalence, the proportion of the population with detectable malaria,
are two metrics used to measure and/or describe malaria transmission.
With respect to the latter, the focus is often on the prevalence rate of
<em>Plasmodium falciparum</em> in children aged two to ten years old,
denoted <em>Pf</em>PR<sub>2-10</sub>.</p>
<p>When setting up a simulation, <code>malariasimulation</code> users
often need to calibrate the model run to an observed level of
transmission. Calibrating to an EIR value can be done directly using the
<code><a href="../reference/set_equilibrium.html">set_equilibrium()</a></code> function, but EIR is difficult to measure
and in practice <em>Pf</em>PR<sub>2-10</sub> is more commonly
recorded/reported as a measure of transmission. However,
<code>malariasimulation</code> does not allow users to calibrate
directly to an <em>Pf</em>PR<sub>2-10</sub> value. To calibrate to a
target <em>Pf</em>PR<sub>2-10</sub>, users must instead identify and
input the EIR value that yields the target <em>Pf</em>PR<sub>2-10</sub>
value. In this vignette, three methods for matching the EIR to a target
<em>Pf</em>PR<sub>2-10</sub> are outlined and compared.</p>
<p>The first and fastest method uses the <code>malariaEquilibrium</code>
package function <code><a href="https://rdrr.io/pkg/malariaEquilibrium/man/human_equilibrium.html" class="external-link">human_equilibrium()</a></code> to calculate the
equilibrium <em>Pf</em>PR<sub>2-10</sub> for a given EIR using the
canonical equilibrium solution for the <code>malariasimulation</code>
model. The second method involves running <code>malariasimulation</code>
simulations across a small set of initial EIR values, extracting the
<em>Pf</em>PR<sub>2-10</sub> from each simulation run, and fitting a
model relating initial EIR to <em>Pf</em>PR<sub>2-10</sub> to allow
users to predict the initial EIR value required to yield the desired
<em>Pf</em>PR<sub>2-10</sub>. The third approach is to calibrate the
model using the <code>cali</code> package function (see <a href="https://github.com/mrc-ide/cali" class="external-link uri">https://github.com/mrc-ide/cali</a> for more information)
<code>calibrate()</code> , which searches a user-defined EIR parameter
space and identifies the value which yields the target
<em>Pf</em>PR<sub>2-10</sub> to a defined tolerance.</p>
<div class="section level2">
<h2 id="pfpr2-10-matching-using-malariaequilibrium">
<em>Pf</em>PR<sub>2-10</sub> matching using malariaEquilibrium<a class="anchor" aria-label="anchor" href="#pfpr2-10-matching-using-malariaequilibrium"></a>
</h2>
<p>The <code>malariaEquilibrium</code> package function
<code><a href="https://rdrr.io/pkg/malariaEquilibrium/man/human_equilibrium.html" class="external-link">human_equilibrium()</a></code> returns the canonical equilibrium
solution for a given EIR and the <em>Pf</em>PR<sub>2-10</sub> can be
calculated from the output (see <a href="https://github.com/mrc-ide/malariaEquilibrium" class="external-link uri">https://github.com/mrc-ide/malariaEquilibrium</a> for more
information). The first step is to set a large range of EIR values to
generate matching <em>Pf</em>PR<sub>2-10</sub> values for. Next, we load
the packageâ€™s default parameter set, specify an effective clinical
treatment coverage (<code>ft</code>) of 0.45 and, for each EIR value
generated, run the <code><a href="https://rdrr.io/pkg/malariaEquilibrium/man/human_equilibrium.html" class="external-link">human_equilibrium()</a></code> function.</p>
<p>The <code><a href="https://rdrr.io/pkg/malariaEquilibrium/man/human_equilibrium.html" class="external-link">human_equilibrium()</a></code> function returns a dataframe
containing the proportion of each age class in each state variable at
equilibrium. The <em>Pf</em>PR<sub>2-10</sub> can be calculated from the
output for each EIR value by summing the proportion of people aged 2-10
with cases of malaria (<code>pos_M</code>) and dividing this proportion
by the proportion of the population between the ages 2-10
(<code>prop</code>). Finally, we store the matching EIR and
<em>Pf</em>PR<sub>2-10</sub> values in a data frame.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Establish a range of EIR values to generate matching PfPR2-10 values for:</span></span>
<span><span class="va">malEq_EIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the base malariaSimulation parameter set:</span></span>
<span><span class="va">q_simparams</span> <span class="op">&lt;-</span> <span class="fu">malariaEquilibrium</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/malariaEquilibrium/man/load_parameter_set.html" class="external-link">load_parameter_set</a></span><span class="op">(</span><span class="st">"Jamie_parameters.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use human_equilibrium() to calculate the PfPR2-10 values for the range of</span></span>
<span><span class="co"># EIR values:</span></span>
<span><span class="va">malEq_prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>  <span class="va">malEq_EIR</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">eir</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">eq</span> <span class="op">&lt;-</span> <span class="fu">malariaEquilibrium</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/malariaEquilibrium/man/human_equilibrium.html" class="external-link">human_equilibrium</a></span><span class="op">(</span></span>
<span>      <span class="va">eir</span>,</span>
<span>      ft <span class="op">=</span> <span class="fl">0.45</span>,</span>
<span>      p <span class="op">=</span> <span class="va">q_simparams</span>,</span>
<span>      age <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">eq</span><span class="op">$</span><span class="va">states</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">11</span>, <span class="st">'pos_M'</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">eq</span><span class="op">$</span><span class="va">states</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">11</span>, <span class="st">'prop'</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Establish a dataframe containing the matching EIR and PfPR2-10 values:</span></span>
<span><span class="va">malEq_P2E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span>EIR <span class="op">=</span> <span class="va">malEq_EIR</span>, prev <span class="op">=</span> <span class="va">malEq_prev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the dataframe containing the EIR and matching PfPR2-10 values:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">malEq_P2E</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="co">#&gt;   EIR       prev</span></span>
<span><span class="co">#&gt; 1 0.1 0.01091840</span></span>
<span><span class="co">#&gt; 2 0.6 0.05245160</span></span>
<span><span class="co">#&gt; 3 1.1 0.08379745</span></span>
<span><span class="co">#&gt; 4 1.6 0.10974305</span></span>
<span><span class="co">#&gt; 5 2.1 0.13217140</span></span>
<span><span class="co">#&gt; 6 2.6 0.15202184</span></span>
<span><span class="co">#&gt; 7 3.1 0.16985615</span></span></code></pre></div>
<p>As this method does not involve running simulations it can return
matching <em>Pf</em>PR<sub>2-10</sub> for a wide range of EIR values
very quickly. However, it is only viable for systems at steady state,
with a fixed set of parameter values, and only enables the user to
capture the effects of the clinical treatment of cases. Often when
running <code>malariasimulation</code> simulations, one or both of these
conditions are not met. In this example, we have set the proportion of
cases effectively treated (<code>ft</code>) to 0.45 to capture the
effect of clinical treatment with antimalarial drugs. However, the user
may, for example, also wish to include the effects of a broader suite of
interventions (e.g.Â bed nets, vaccines, etc.), or to capture changes in
the proportion of people clinically treated over time. In these cases, a
different solution would therefore be required.</p>
</div>
<div class="section level2">
<h2 id="pfpr2-10-matching-using-malariasimulation">
<em>Pf</em>PR<sub>2-10</sub> matching using malariasimulation<a class="anchor" aria-label="anchor" href="#pfpr2-10-matching-using-malariasimulation"></a>
</h2>
<p>Where the <code>malariaEquilibrium</code> method is not viable, an
alternative is to run <code>malariasimulation</code> simulations over a
smaller range of initial EIR values, extract the
<em>Pf</em>PR<sub>2-10</sub> from each run, fit a model relating initial
EIR to <em>Pf</em>PR<sub>2-10</sub>, and use the model to predict the
initial EIR value required to yield the desired
<em>Pf</em>PR<sub>2-10</sub>. This approach allows users to benefit from
the tremendous flexibility in human population, mosquito population, and
intervention package parameters afforded by the
<code>malariasimulation</code> package. An example of this method is
outlined below.</p>
<div class="section level3">
<h3 id="establish-malariasimulation-parameters">Establish malariasimulation parameters<a class="anchor" aria-label="anchor" href="#establish-malariasimulation-parameters"></a>
</h3>
<p>To run <code>malariasimulation</code>, the first step is to generate
a list of parameters using the <code><a href="../reference/get_parameters.html">get_parameters()</a></code> function,
which loads the default <code>malariasimulation</code> parameter list.
Within this function call, we adapt the average age of the human
population to flatten its demographic profile, instruct the model to
output malaria prevalence in the age range of 2-10 years old, and switch
off the individual-based mosquito module. The <code><a href="../reference/set_species.html">set_species()</a></code>
function is then called to specify a vector community composed of
<em>An. gambiae</em>, <em>An. funestus</em>, and <em>An arabiensis</em>
at a ratio of 2:1:1. The <code><a href="../reference/set_drugs.html">set_drugs()</a></code> function is used to
append the built-in parameters for artemether lumefantrine (AL) and,
finally, the <code><a href="../reference/set_clinical_treatment.html">set_clinical_treatment()</a></code> function is called to
specify a treatment campaign that distributes AL to 45% of the
population in the first time step (t = 1).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify the time frame over which to simulate and the human population size:</span></span>
<span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">365</span></span>
<span><span class="va">human_population</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span></span>
<span><span class="co"># Use the get_parameters() function to establish a list of simulation parameters:</span></span>
<span><span class="va">simparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_parameters.html">get_parameters</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co"># Set the population size:</span></span>
<span>  human_population <span class="op">=</span> <span class="va">human_population</span>,</span>
<span>  </span>
<span>  <span class="co"># Set the average age (days) of the population:</span></span>
<span>  average_age <span class="op">=</span> <span class="fl">23</span> <span class="op">*</span> <span class="va">year</span>,   </span>
<span>  </span>
<span>  <span class="co"># Instruct model to render prevalence in age group 2-10:</span></span>
<span>  prevalence_rendering_min_ages <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">year</span>,    </span>
<span>  prevalence_rendering_max_ages <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the set_species() function to specify the mosquito population (species and </span></span>
<span><span class="co"># relative abundances):</span></span>
<span><span class="va">simparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_species.html">set_species</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">simparams</span>, </span>
<span>                         species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">arab_params</span>, <span class="va">fun_params</span>, <span class="va">gamb_params</span><span class="op">)</span>, </span>
<span>                         proportions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the set_drugs() function to append the in-built parameters for the </span></span>
<span><span class="co"># drug artemether lumefantrine (AL):</span></span>
<span><span class="va">simparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_drugs.html">set_drugs</a></span><span class="op">(</span><span class="va">simparams</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">AL_params</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the set_clinical_treatment() function to parameterise human </span></span>
<span><span class="co"># population treatment with AL in the first timestep:</span></span>
<span><span class="va">simparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_clinical_treatment.html">set_clinical_treatment</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">simparams</span>, </span>
<span>                                    drug <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    timesteps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                                    coverages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-the-simulations-and-calculate-pfpr2-10">Run the simulations and calculate <em>Pf</em>PR<sub>2-10</sub><a class="anchor" aria-label="anchor" href="#run-the-simulations-and-calculate-pfpr2-10"></a>
</h3>
<p>Having established a set of <code>malariasimulation</code>
parameters, we are now ready to run simulations. In the following code
chunk, weâ€™ll run the <code><a href="../reference/run_simulation.html">run_simulation()</a></code> function across a
range of initial EIR values to generate sufficient points to fit a curve
matching <em>Pf</em>PR<sub>2-10</sub> to the initial EIR. For each
initial EIR, we first use the <code><a href="../reference/set_equilibrium.html">set_equilibrium()</a></code> to update
the model parameter list with the human and vector population parameter
values required to achieve the specified EIR at equilibrium. This
updated parameter list is then used to run the simulation.</p>
<p>The <code><a href="../reference/run_simulation.html">run_simulation()</a></code> outputs an EIR per time step, per
species, across the entire human population. We first convert these to
get the number of infectious bites experienced, on average, by each
individual across the final year across all vector species. Next, the
average <em>Pf</em>PR<sub>2-10</sub> across the final year of the
simulation is calculated by dividing the total number of individuals
aged 2-10 by the number (<code>n_age_730_3650</code>) of detectable
cases of malaria in individuals aged 2-10
(<code>n_detect_lm_730_3650</code>) on each day and calculating the mean
of these values. Finally, initial EIR, output EIR, and
<em>Pf</em>PR<sub>2-10</sub> are stored in a data frame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Establish a vector of initial EIR values to simulate over and generate matching</span></span>
<span><span class="co"># PfPR2-10 values for:</span></span>
<span><span class="va">init_EIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each initial EIR, calculate equilibrium parameter set and run the simulation:</span></span>
<span><span class="va">malSim_outs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">init_EIR</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">init</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_equilibrium.html">set_equilibrium</a></span><span class="op">(</span><span class="va">simparams</span>, <span class="va">init</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/run_simulation.html">run_simulation</a></span><span class="op">(</span><span class="fl">5</span> <span class="op">*</span> <span class="va">year</span>, <span class="va">p_i</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert the default EIR output (per vector species, per timestep, across </span></span>
<span><span class="co"># the entire human population) to a cross-vector species average EIR per</span></span>
<span><span class="co"># person per year across the final year of the simulation:</span></span>
<span><span class="va">malSim_EIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">malSim_outs</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span></span>
<span>        <span class="va">output</span><span class="op">[</span></span>
<span>          <span class="va">output</span><span class="op">$</span><span class="va">timestep</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="fl">365</span>, <span class="fl">5</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'EIR_'</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span> <span class="op">/</span> <span class="va">human_population</span> <span class="op">*</span> <span class="va">year</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the average PfPR2-10 value across the final year for each initial</span></span>
<span><span class="co"># EIR value:</span></span>
<span><span class="va">malSim_prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">malSim_outs</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>      <span class="va">output</span><span class="op">[</span></span>
<span>        <span class="va">output</span><span class="op">$</span><span class="va">timestep</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="fl">365</span>, <span class="fl">5</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span>,</span>
<span>        <span class="st">'n_detect_lm_730_3650'</span></span>
<span>      <span class="op">]</span> <span class="op">/</span> <span class="va">output</span><span class="op">[</span></span>
<span>        <span class="va">output</span><span class="op">$</span><span class="va">timestep</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="fl">365</span>, <span class="fl">5</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span>,</span>
<span>        <span class="st">'n_age_730_3650'</span></span>
<span>      <span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span> </span>
<span><span class="co"># Create dataframe of initial EIR, output EIR, and PfPR2-10 results:</span></span>
<span><span class="va">malSim_P2E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span><span class="va">init_EIR</span>, EIR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">malSim_EIR</span><span class="op">)</span>, prev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">malSim_prev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the dataframe containing the EIR and matching PfPR2-10 values:</span></span>
<span><span class="va">malSim_P2E</span></span>
<span><span class="co">#&gt;   init_EIR         EIR        prev</span></span>
<span><span class="co">#&gt; 1     0.01  0.01865945 0.002635393</span></span>
<span><span class="co">#&gt; 2     0.10  0.09282683 0.007495763</span></span>
<span><span class="co">#&gt; 3     1.00  1.18501613 0.096890083</span></span>
<span><span class="co">#&gt; 4     5.00  5.83869188 0.268115857</span></span>
<span><span class="co">#&gt; 5    10.00 11.30439827 0.343008297</span></span>
<span><span class="co">#&gt; 6    25.00 25.74267129 0.483218187</span></span>
<span><span class="co">#&gt; 7    50.00 54.26493735 0.611062770</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-line-of-best-fit-relating-initial-eir-values-to-pfpr2-10">Fit line of best fit relating initial EIR values to
<em>Pf</em>PR<sub>2-10</sub><a class="anchor" aria-label="anchor" href="#fit-line-of-best-fit-relating-initial-eir-values-to-pfpr2-10"></a>
</h3>
<p>Having run <code>malariasimulation</code> simulations for a range of
initial EIRs, we can fit a line of best fit through the initial EIR and
<em>Pf</em>PR<sub>2-10</sub> data using the <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam()</a></code> function
(<code>mgcv</code>) and then use the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function to
return the <em>Pf</em>PR<sub>2-10</sub> for a wider range of initial
EIRs (given the set of parameters used).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit a line of best fit through malariasimulation initial EIR and PfPR2-10</span></span>
<span><span class="co"># and use it to predict a series of PfPR2-10 values for initial EIRs ranging</span></span>
<span><span class="co"># from 0.1 to 50:</span></span>
<span><span class="va">malSim_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">prev</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">init_EIR</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">malSim_P2E</span><span class="op">)</span>, </span>
<span>                      newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>init_EIR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">50</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a dataframe of initial EIR values and PfPR2-10 values:</span></span>
<span><span class="va">malSim_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">malSim_fit</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>init_EIR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span> ,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">50</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="visualisation">Visualisation<a class="anchor" aria-label="anchor" href="#visualisation"></a>
</h2>
<p>Letâ€™s visually compare the <code>malariaEquilibrium</code> and
<code>malariasimulation</code> methods for matching EIR to
<em>Pf</em>PR<sub>2-10</sub> values. In the section below we open a
blank plot, plot the initial EIR and resulting
<em>Pf</em>PR<sub>2-10</sub> points generated using
<code>malariasimulation</code> runs and overlay the line of best fit
(orange line). Also overlayed is a line mapping EIR and
<em>Pf</em>PR<sub>2-10</sub> values calculated using
<code>malariaEquilibrium</code> (blue line).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Establish a plotting window:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"Initial EIR"</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu">italic</span><span class="op">(</span><span class="va">Pf</span><span class="op">)</span>,<span class="st">"PR"</span><span class="op">[</span><span class="fl">2</span><span class="op">-</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>     xaxs <span class="op">=</span> <span class="st">"i"</span>, yaxs <span class="op">=</span> <span class="st">"i"</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey80"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Overlay the initial EIR and corresponding PfPR2-10 points from malariasimulation:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">malSim_P2E</span><span class="op">$</span><span class="va">init_EIR</span>, </span>
<span>       y <span class="op">=</span> <span class="va">malSim_P2E</span><span class="op">$</span><span class="va">prev</span>,</span>
<span>       pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>       col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Overlay the malariasimulation line of best fit:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">malSim_fit</span><span class="op">$</span><span class="va">init_EIR</span>, </span>
<span>      y <span class="op">=</span> <span class="va">malSim_fit</span><span class="op">$</span><span class="va">malSim_fit</span>, </span>
<span>      col <span class="op">=</span> <span class="va">cols</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>, </span>
<span>      lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Overlay the malariaEquilibrium EIR to PfPR2-10 line:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">malEq_P2E</span><span class="op">$</span><span class="va">EIR</span>, </span>
<span>      y <span class="op">=</span> <span class="va">malEq_P2E</span><span class="op">$</span><span class="va">prev</span>, </span>
<span>      col <span class="op">=</span> <span class="va">cols</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, </span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a legend:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"malariasimulation"</span>, <span class="st">"malariaEquilibrium"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>       box.col <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>       cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="EIRprevmatch_Fig_1.png" style="display:block; margin: 0 auto; border-width: 0; width: 100%"></p>
<p>We can see that the <code>malariaEquilibrium</code> provides a
reasonable approximation when the target <em>Pf</em>PR<sub>2-10</sub> is
low, but recommends slightly different initial EIR values for
intermediate <em>Pf</em>PR<sub>2-10</sub> values. However, in our
example we only simulated clinical treatment covering 45% of the
population. If we needed to identify the EIR to yield a target
<em>Pf</em>PR<sub>2-10</sub> value in a scenario in which additional
interventions, such as bed nets or vaccines, had been deployed, the
difference between the EIR value recommended by these methods would be
likely to increase significantly.</p>
</div>
<div class="section level2">
<h2 id="matching-eir-to-pfpr2-10-values">Matching EIR to <em>Pf</em>PR<sub>2-10</sub> values<a class="anchor" aria-label="anchor" href="#matching-eir-to-pfpr2-10-values"></a>
</h2>
<p>Using the fitted relationship between initial EIR and
<em>Pf</em>PR<sub>2-10</sub>, we can create a function that returns the
EIR value(s) estimated to yield a target <em>Pf</em>PR<sub>2-10</sub>
given the model parameters. The function works by finding the closest
<em>Pf</em>PR<sub>2-10</sub> value from the values generated when we fit
the model to a target value input by the user, and then using that index
to return the corresponding initial EIR value.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Store some target PfPR2-10 values to match to:</span></span>
<span><span class="va">PfPRs_to_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.25</span>, <span class="fl">0.35</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a function to match these baseline PfPR2-10 values to EIR values</span></span>
<span><span class="co"># using the model fit:</span></span>
<span><span class="va">match_EIR_to_PfPR</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">malSim_fit</span><span class="op">$</span><span class="va">malSim_fit</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">malSim_fit</span><span class="op">[</span><span class="va">m</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use the function to extract the EIR values for the specified </span></span>
<span><span class="co"># PfPR2-10 values:</span></span>
<span><span class="va">matched_EIRs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">PfPRs_to_match</span>, <span class="va">match_EIR_to_PfPR</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a dataframe of matched PfPR2-10 and EIR values:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span>PfPR <span class="op">=</span> <span class="va">PfPRs_to_match</span>, Matched_EIR <span class="op">=</span> <span class="va">matched_EIRs</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calibrating-pfpr2-10-using-the-cali-package">Calibrating <em>Pf</em>PR<sub>2-10</sub> using the cali package<a class="anchor" aria-label="anchor" href="#calibrating-pfpr2-10-using-the-cali-package"></a>
</h2>
<p>The third option is to use the <code>calibrate()</code> function from
the <code>cali</code> package (for details see: <a href="https://github.com/mrc-ide/cali" class="external-link uri">https://github.com/mrc-ide/cali</a>) to return the EIR
required to yield a target <em>Pf</em>PR<sub>2-10</sub>. Rather than
manually running a series of simulations with varied, user-defined EIRs,
this package contains the <code>calibrate()</code> function, which
calibrates <code>malariasimulation</code> simulation outputs to a target
<em>Pf</em>PR<sub>2-10</sub> value within a user-specified tolerance by
trying a series of EIR values within a defined range.</p>
<p>The <code>calibrate()</code> function accepts as inputs a list of
<code>malariasimulation</code> parameters, a summary function that takes
the <code>malariasimulation</code> output and returns a vector of the
target variable (e.g.Â a function that returns the
<em>Pf</em>PR<sub>2-10</sub>), and a tolerance within which to accept
the output target variable value and terminate the routine. To reduce
the time taken by the <code>calibrate()</code> function, the user can
also specify upper and lower bounds for the EIR space the function will
search. The function runs through a series of
<code>malariasimulation</code> simulations, trying different EIRs and
honing in on the target value of the target variable, terminating when
the target value output falls within the tolerance specified.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">cali</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare a summary function that returns the mean PfPR2-10 from each simulation output: </span></span>
<span><span class="va">summary_mean_pfpr_2_10</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span> </span>
<span> <span class="co"># Calculate the PfPR2-10:</span></span>
<span> <span class="va">prev_2_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">n_detect_lm_730_3650</span><span class="op">/</span><span class="va">x</span><span class="op">$</span><span class="va">n_age_730_3650</span><span class="op">)</span></span>
<span> </span>
<span> <span class="co"># Return the calculated PfPR2-10:</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prev_2_10</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Establish a target PfPR2-10 value:</span></span>
<span><span class="va">target_pfpr</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span></span>
<span><span class="co"># Add a parameter to the parameter list specifying the number of timesteps to</span></span>
<span><span class="co"># simulate over. Note, increasing the number of steps gives the simulation longer</span></span>
<span><span class="co"># to stablise/equilibrate, but will increase the runtime for calibrate().  </span></span>
<span><span class="va">simparams</span><span class="op">$</span><span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="op">*</span> <span class="fl">365</span></span>
<span></span>
<span><span class="co"># Establish a tolerance value:</span></span>
<span><span class="va">pfpr_tolerance</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span></span>
<span><span class="co"># Set upper and lower EIR bounds for the calibrate function to check (remembering EIR is</span></span>
<span><span class="co"># the variable that is used to tune to the target PfPR):</span></span>
<span><span class="va">lower_EIR</span> <span class="op">&lt;-</span> <span class="fl">5</span>; <span class="va">upper_EIR</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="co"># Run the calibrate() function:</span></span>
<span><span class="va">cali_EIR</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span>target <span class="op">=</span> <span class="va">target_pfpr</span>,</span>
<span>                      summary_function <span class="op">=</span> <span class="va">summary_mean_pfpr_2_10</span>,</span>
<span>                      parameters <span class="op">=</span> <span class="va">simparams</span>,</span>
<span>                      tolerance <span class="op">=</span> <span class="va">pfpr_tolerance</span>, </span>
<span>                      low <span class="op">=</span> <span class="va">lower_EIR</span>, high <span class="op">=</span> <span class="va">upper_EIR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the match_EIR_to_PfPR() function to return the EIR predicted to be required under the</span></span>
<span><span class="co"># malariasimulation method:</span></span>
<span><span class="va">malsim_EIR</span> <span class="op">&lt;-</span> <span class="fu">match_EIR_to_PfPR</span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_pfpr</span><span class="op">)</span></span></code></pre></div>
<p>The <code>calibrate()</code> function is a useful tool, but be aware
that it relies on the user selecting and accurately coding an effective
summary function, providing reasonable bounds on the EIR space to
explore, and selecting a population size sufficiently large to limit the
influence of stochasticity.</p>
<p>As a final exercise, letâ€™s compare graphically the
<code>calibrate()</code> approach with the
<code>malariasimulation</code> method when the same parameter set is
used. The plot below shows the change in <em>Pf</em>PR<sub>2-10</sub>
over the duration of the simulation under the initial EIR values
recommended by the a) <code>cali</code> and b)
<code>malariasimulation</code> methods to achieve the target
<em>Pf</em>PR<sub>2-10</sub> value of 0.3. The blue horizontal line
represents the target <em>Pf</em>PR<sub>2-10</sub> and the black lines
either side are the upper and lower tolerance limits specified for the
<code>cali</code> method.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use the set_equilibrium() function to calibrate the simulation parameters to the EIR:</span></span>
<span><span class="va">simparams_cali</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_equilibrium.html">set_equilibrium</a></span><span class="op">(</span><span class="va">simparams</span>, init_EIR <span class="op">=</span> <span class="va">cali_EIR</span><span class="op">)</span></span>
<span><span class="va">simparams_malsim</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_equilibrium.html">set_equilibrium</a></span><span class="op">(</span><span class="va">simparams</span>, init_EIR <span class="op">=</span> <span class="va">malsim_EIR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the simulation:</span></span>
<span><span class="va">cali_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="op">(</span><span class="va">simparams_cali</span><span class="op">$</span><span class="va">timesteps</span><span class="op">)</span>,</span>
<span>                           parameters <span class="op">=</span> <span class="va">simparams_cali</span><span class="op">)</span></span>
<span><span class="va">malsim_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>timesteps <span class="op">=</span> <span class="op">(</span><span class="va">simparams_malsim</span><span class="op">$</span><span class="va">timesteps</span><span class="op">)</span>,</span>
<span>                             parameters <span class="op">=</span> <span class="va">simparams_malsim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the PfPR2-10 values for the cali and malsim simulation outputs:</span></span>
<span><span class="va">cali_pfpr2_10</span> <span class="op">&lt;-</span> <span class="va">cali_sim</span><span class="op">$</span><span class="va">n_detect_lm_730_3650</span> <span class="op">/</span> <span class="va">cali_sim</span><span class="op">$</span><span class="va">n_age_730_3650</span></span>
<span><span class="va">malsim_pfpr2_10</span> <span class="op">&lt;-</span> <span class="va">malsim_sim</span><span class="op">$</span><span class="va">n_detect_lm_730_3650</span> <span class="op">/</span> <span class="va">malsim_sim</span><span class="op">$</span><span class="va">n_age_730_3650</span></span>
<span></span>
<span><span class="co"># Store the PfPR2-10 in each time step for the two methods:</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>timestep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cali_pfpr2_10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 cali_pfpr <span class="op">=</span> <span class="va">cali_pfpr2_10</span>,</span>
<span>                 malsim_pfpr <span class="op">=</span> <span class="va">malsim_pfpr2_10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the plotting window:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the PfPR2-10 under the EIR recommended by the cali method:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">timestep</span>,</span>
<span>     y <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">malsim_pfpr</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu">italic</span><span class="op">(</span><span class="va">Pf</span><span class="op">)</span>,<span class="st">"PR"</span><span class="op">[</span><span class="fl">2</span><span class="op">-</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (days)"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">target_pfpr</span> <span class="op">-</span> <span class="fl">0.2</span>, <span class="va">target_pfpr</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>     <span class="co">#ylim = c(0, 1),</span></span>
<span>     col <span class="op">=</span> <span class="va">cols</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add grid lines</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey80"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a textual identifier and lines indicating target PfPR2-10 with</span></span>
<span><span class="co"># tolerance bounds:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">0.47</span>, pos <span class="op">=</span> <span class="fl">4</span>, cex <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"a) cali \n init_EIR = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cali_EIR</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span>, col <span class="op">=</span> <span class="st">"dodgerblue"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span> <span class="op">-</span> <span class="va">pfpr_tolerance</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span> <span class="op">+</span> <span class="va">pfpr_tolerance</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the PfPR2-10 under the EIR recommended by the malariasimulation method:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">timestep</span>,</span>
<span>     y <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">cali_pfpr</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (days)"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">""</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">target_pfpr</span> <span class="op">-</span> <span class="fl">0.2</span>, <span class="va">target_pfpr</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>     <span class="co">#ylim = c(0, 1),</span></span>
<span>     col <span class="op">=</span> <span class="va">cols</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add grid lines</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey80"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a textual identifier and lines indicating target PfPR2-10 with</span></span>
<span><span class="co"># tolerance bounds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">0.47</span>, pos <span class="op">=</span> <span class="fl">4</span>, cex <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"b) malariasimulation \n init_EIR = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">malsim_EIR</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span>, col <span class="op">=</span> <span class="st">"dodgerblue"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span> <span class="op">-</span> <span class="va">pfpr_tolerance</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">target_pfpr</span> <span class="op">+</span> <span class="va">pfpr_tolerance</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="EIRprevmatch_Fig_2.png" style="display:block; margin: 0 auto; border-width: 0; width: 100%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Giovanni Charles, Peter Winskill, Hillary Topazian, Joseph Challenger, Richard Fitzjohn, Richard Sheppard, Tom Brewer, Kelly McCain, Lydia Haile.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
