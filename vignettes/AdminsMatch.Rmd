---
title: "Parameterizing Model for Site-specific Values"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EIRprevmatch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=F, warning=F}
library(malariasimulation)
library(umbrella) # remotes::install_github('mrc-ide/umbrella@gee', force=T)
library(reticulate)
library(rgee) # remotes::install_github('r-spatial/rgee', force=T)
library(sf)

```

This vignette describes how to parameterize `malariasimulation` for site-specific seasonality and intervention parameters. 

# Seasonality

Seasonality is incorporated into `malariasimulation` through the `get_parameters()` function. 

```{r class.source="bg-warning", echo=FALSE}
params <- get_parameters(list(
  model_seasonality = TRUE,                 # model seasonal rainfall
  g0 = 0.284596,                            # rainfall fourier parameters
  g = c(-0.317878, -0.0017527, 0.116455),     
  h = c(-0.331361, 0.293128, -0.0617547))     
```

To calculate the g and h rainfall fourier parameters for a specific place and time, we can use the [umbrella package](https://github.com/mrc-ide/umbrella/tree/gee). To install `umbrella`, follow the instructions on the [package website](https://github.com/mrc-ide/umbrella/tree/gee) to install `rgee` and Google Earth Engine. 

```{r class.source="bg-warning", echo=FALSE}
# Set python version (needs to be <=3.9!) and install earthengine --------------
py_discover_config() # check version
import('sys')$executable
reticulate::use_python('C:/Users/htopazia/Anaconda3/python.exe', required=T)
Sys.setenv(RETICULATE_PYTHON="C:/Users/htopazia/Anaconda3/envs/rgee/python.exe")
options(reticulate.conda_binary = "C:/Users/htopazia/Anaconda3/envs/rgee/python.exe")

# Use Anaconda prompt to create a new environment
# conda create --name rgee python=3.9
# conda activate rgee
# conda install -c conda-forge earthengine-api

# install earthengine
rgee::ee_install_set_pyenv(py_path = "C:/Users/htopazia/Anaconda3/envs/rgee/python.exe", 
                           py_env = 'rgee')
# ::ee_clean_pyenv() # to clear and start over 

# check
ee_check() # may encounter an error but keep going
# usethis::edit_r_environ() # to check environment

# sign into google earth account
ee_Initialize(user='htopazian@gmail.com', drive=T) # Users/htopazian_earthengine
```

<br>


```{r}
# import spatial data
admin1 <- readRDS(url("https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_KEN_1_sf.rds"))
sites <- admin1[which(admin1$NAME_1 %in% c('Bomet','Kericho')),]
  
# plot
plot(st_geometry(admin1), lwd = 2, col = 'green'))
plot(st_geometry(sites), col = 'yellow', add = T)

# specify time-range
start_date <- "2015-01-01"
end_date <- "2016-12-31"

# extract
daily_rain <- pull_daily_rainfall(sf = admin2, start_date = start_date, end_date = end_date)

# process
seasonality <- process(gee_output = daily_rain, ISO, Country, admin1, admin2)

# inspect
seasonality %>%
  select(admin1, coefficients) %>%
  tidyr::unnest(cols = c(coefficients))

pd <- seasonality %>%
  select(admin1, profile) %>%
  tidyr::unnest(cols = c(profile)) %>%
  mutate(day = t * 365)

ggplot(pd, aes(x = day, y = y, col = admin1)) +
  geom_line() +
  xlab("Day") +
  ylab("Precipitation") +
  theme_bw()
```  
```{r parameters}
year <- 365
human_population <- 5000

params <- get_parameters(list(
  human_population = human_population,
  average_age = 8453.323,     # to match flat_demog
  model_seasonality = TRUE,   # assign seasonality
  g0 = 0.284596,                              
  g = c(-0.317878, -0.0017527, 0.116455),     
  h = c(-0.331361, 0.293128, -0.0617547),     
  prevalence_rendering_min_ages = 2 * year,    # set prev age range
  prevalence_rendering_max_ages = 10 * year,
  fvt = 0,
  v = 0,
  severe_enabled = T,
  individual_mosquitoes = FALSE))

  # set species / drugs / treatment parameters
params <- set_species(params, species = list(arab_params, fun_params, gamb_params), 
                      proportions = c(0.25, 0.25, 0.5))
params <- set_drugs(params, list(AL_params))
params <- set_clinical_treatment(params, 1, c(1), c(0.45))

```

# Interventions



