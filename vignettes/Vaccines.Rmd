---
title: "Vaccines"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vaccines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(malariasimulation)
library(dplyr)
library(tidyr)

cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

# Plotting functions
```{r} 
# Plotting clinical incidence 
plot_inci <- function(){
  output$clinical_incidence <- 1000 * output$n_inc_0_1825 / output$n_0_1825
  output$time_year <- output$timestep / year

  plot(x = output$time_year, y = output$clinical_incidence, 
       type = 'l', col = cols[3],
       xlab = 'Time (years)', ylab = 'Clinical incidence (per 1000 children aged 0-5)',
       xaxs = "i", yaxs = "i", bty = "l")
  abline(v = 1, col = cols[7], lty = 2, lwd = 2.5)
  curve_values <- loess(clinical_incidence ~ time_year, data = output, span = 0.3, method = 'loess') 
  lines(output$time_year, predict(curve_values),
        col = cols[6],
        lwd = 3)
  legend('topright', box.lty = 0, legend = 'Vaccination',col = cols[7], lty = 2, lwd = 2.5)
}

# Plot parasite prevalence
plot_prev <- function(){
  output$time_year <- output$timestep / year

  plot(x = output$time_year, y = output$n_detect_730_3650/output$n_730_3650, 
       type = 'l', col = cols[4],
       xlab = 'Time (years)', ylab = expression(paste(italic(Pf),"PR"[2-10])),
       xaxs = "i", yaxs = "i", bty = "l")
  abline(v = 1, col = cols[7], lty = 2, lwd = 2.5)
  legend('topright', box.lty = 0, legend = 'Vaccination',col = cols[7], lty = 2, lwd = 2.5)
}

plot_doses <- function(){
  if(any(names(output) == 'n_rtss_epi_dose_1')) {
    doses <- output |> 
      select(timestep, starts_with('n_rtss_epi')) |>
      pivot_longer(starts_with('n_rtss_epi'), names_to = "dose", values_to = "count") |>
      mutate(month = ceiling(timestep / month)) |>
      group_by(month, dose) |>
      summarize(count = sum(count)) |> ungroup() |>
      pivot_wider(names_from = dose, values_from = count) %>% 
      select(-month) %>% t %>% as.matrix()
    
    barplot(doses, xlab = "Month",
            ylab = 'Number of doses',
          col = cols[2:7],
          beside = FALSE)
    legend('topleft', box.lty = 0, legend = c('Booster 1','Dose 1','Dose 2','Dose 3'),
           col = cols[2:7], lty = rep(1, 4), lwd = 2.5,bg="transparent")
    
  } else if (any(names(output) == 'n_rtss_mass_dose_1')) {
    doses <- output |> 
      select(timestep, starts_with('n_rtss_mass')) |>
      pivot_longer(starts_with('n_rtss_mass'), names_to = "dose", values_to = "count") |>
      mutate(month = ceiling(timestep / month)) |>
      group_by(month, dose) |>
      summarize(count = sum(count)) |> ungroup() |>
      pivot_wider(names_from = dose, values_from = count) %>% 
      select(-month) %>% t %>% as.matrix()
    
    barplot(doses, xlab = "Month",
            ylab = 'Number of doses',
          col = cols[2:7],
          beside = FALSE)
    legend('topleft',  box.lty = 0, legend = c('Booster 1','Dose 1','Dose 2','Dose 3'),
           col = cols[2:7], lty = rep(1, 4), lwd = 2.5,bg="transparent")
  }
}
```

# Parameterisation

We are going to set the default parameters to run the simulation from an equilibrium.

```{r}
year <- 365
month <- 30
sim_length <- 3 * year
human_population <- 10000
starting_EIR <- 20

simparams <- get_parameters(list(
    human_population = human_population,
    incidence_rendering_min_ages = 0,
    incidence_rendering_max_ages = 5 * year,
    individual_mosquitoes = FALSE
  )
)

simparams <- set_equilibrium(simparams, starting_EIR)
```

Then we can run the simulation for a variety of vaccination strategies for RTS,S:

## Mass RTS,S

This is a single round of RTS,S vaccine given in a mass vaccination strategy for individuals between 5 months and 10 years, followed by a booster after 12 months:

```{r}
rtssparams <- simparams

rtssparams <- set_mass_rtss(
  rtssparams,
  timesteps = 1 * year, # The single round of vaccination is at 1 year into the simulation.
  coverages = 1, # The vaccine is given to 100% of the population between the specified ages.
  min_wait = 0, # The minimum acceptable time since the last vaccination is 0.
  min_ages = 5 * month, # The minimum age for the target population to be vaccinated. 
  max_ages = 10 * year, # The maximum age for the target population to be vaccinated.
  boosters = 12 * month, # The booster is given at 12 months after the initial vaccination. 
  booster_coverage = 0.95 # Coverage of the booster dose is 95%.
)

output <- run_simulation(sim_length, rtssparams)
```

### Plot clinical incidence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_inci()
```

### Plot prevalence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_prev()
```

### Plot doses
You can look at the distribution of doses using the `n_rtss_mass_dose\_\*` or `n_rtss_epi_dose\_\*` outputs. It is always a good idea to check the timing of vaccine doses to ensure that it is specified as intended.
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_doses()
```

## RTS,S EPI

You can opt for a more gradual dosing using the EPI strategy. In the example below, individuals will be vaccinated once they reach 5 months of age. For this intervention, we see a much more gradual increase in impact following implementation.

```{r}
rtssepiparams <- simparams

# Add RTS,S strategy
rtssepiparams <- set_rtss_epi(
  rtssepiparams,
  timesteps = 1 * year, # Vaccination will begin at 1 year.
  coverages = 1, # Vaccine coverage is 100%.
  min_wait = 0, # There is no minimum wait since the last vaccination.
  age = 5 * month, # Individuals will be vaccinated once they reach 5 months of age.
  boosters = 12 * month, # The booster is administered 12 months following the initial vaccination. 
  booster_coverage = 0.95 # 95% of those vaccinated with the primary series will be boosted.
)

output <- run_simulation(sim_length * 2, rtssepiparams)
```


### Plot clinical incidence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_inci()
```

### Plot prevalence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_prev()
```

### Plot doses
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_doses()
```
  
  
## RTS,S seasonal boosters

In a seasonal setting, we can set booster timesteps relative to the start of the year. This allows us to target seasonal dynamics. 

```{r}
rtssepiseasonalparams <- simparams
rtssepiseasonalparams$model_seasonality = TRUE
rtssepiseasonalparams$g0 = 0.28605
rtssepiseasonalparams$g = c(0.20636, -0.0740318, -0.0009293)
rtssepiseasonalparams$h = c(0.173743, -0.0730962, -0.116019)
# Calculate the peak of the transmission season based on seasonality parameters above.
peak <- peak_season_offset(rtssepiseasonalparams) 

# Add RTS,S seasonal strategy
rtssepiseasonalparams <- set_rtss_epi(
  rtssepiseasonalparams,
  timesteps = 1 * year, # Vaccination begins 1 year after the start of the simulation. 
  coverages = 1, # Vaccine coverage is 100%.
  min_wait = 6 * month, # When seasonal_boosters = TRUE, this is the minimum time between an individual receiving the final dose and the first booster.
  age = 5 * month, # Individuals will be vaccinated once they reach 5 months of age.
  boosters = round(c(12 * month + 2 * month)), # There is one booster, a year and 2 months after the final dose of the primary series. 
  booster_coverage = c(.7), # 70% of the vaccinated population is boosted.
  seasonal_boosters = TRUE
)

output <- run_simulation(sim_length * 2, rtssepiseasonalparams)
```


### Plot clinical incidence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_inci()
```

### Plot prevalence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_prev()
```

### Plot doses
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_doses()
```

## RTS,S dosing

You can try different dosing schedules using the `rtss_doses` parameter. As before, it is a good idea to visualise the timing of the vaccination strategy to ensure that you have implemented it as intended.

```{r}
rtssepiparams2 <- rtssepiparams
rtssepiparams2$rtss_doses <- c(0, 30, 60) # setting the timesteps for the 3 doses in the primary series at 0, 1, 2 months

rtssepiparams2 <- set_rtss_epi(
  rtssepiparams2,
  timesteps = 1 * year,
  coverages = 1,
  age = 5 * month,
  min_wait = 0,
  boosters = c(12 * month, 24 * month), # Here, we are testing a strategy with 2 boosters.
  booster_coverage = c(1, 1)
)

output <- run_simulation(sim_length * 2, rtssepiparams2)
```


### Plot clinical incidence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_inci()
```

### Plot prevalence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_prev()
```

### Plot doses
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_doses()
```
  
  
## TBV

We can also model vaccines with completely different modes of actions. For example, a transmission blocking vaccine (TBV). This example shows 5 rounds of a TBV to everyone aged 5 years or older.

```{r}
tbvparams <- simparams

tbvparams <- set_tbv(
  tbvparams,
  timesteps = round(c(1, 1.25, 1.5, 1.75, 2) * 365),
  coverages = rep(0.99, 5),
  ages = 5:60
)

output <- run_simulation(sim_length, tbvparams)
```

### Plot clinical incidence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_inci()
```

### Plot prevalence
```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
plot_prev()
```
