---
title: "Vector Control"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vector Control}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(ggplot2))
library(malariasimulation)
library(malariaEquilibrium)
library(reshape2)
```

# Parameterisation

We are going to set the default parameters to run the simulation from an equilibrium.

```{r}
year <- 365
month <- 30
sim_length <- 5 * year
human_population <- 1000
starting_EIR <- 50

simparams <- get_parameters(
  list(
    human_population = human_population,
    model_seasonality = TRUE, # Let's try a bi-modal model
    g0 = 0.28605,
    g = c(0.20636, -0.0740318, -0.0009293),
    h = c(0.173743, -0.0730962, -0.116019),
    prevalence_rendering_min_ages = 2*year,
    prevalence_rendering_max_ages = 10*year,
    
    individual_mosquitoes = FALSE
  )
)

# set mosquito species
simparams <- set_species(simparams,
                         species=list(gamb_params, arab_params, fun_params),
                         proportions=c(0.5,0.25,0.25)
                        
)

simparams <- set_equilibrium(simparams, starting_EIR)

# Plotting functions
plot_prevalence <- function(output) {
  ggplot(output) + geom_line(
    aes(x = timestep, y = (n_detect_730_3650 / n_730_3650))) + 
    labs(x = "timestep", y = "Prevalence")
}

add_intervention_lines <- function(plot, events) {
  plot + geom_vline(
    data = events,
    mapping = aes(xintercept=timestep),
    color="blue"
  ) + geom_text(
    data = events,
    mapping = aes(x = timestep, y = 0, label = name),
    size = 4,
    angle = 90,
    vjust = -0.4,
    hjust = 0
  )
}
```

Then we can run the simulation for a variety of vector control strategies:

## Bed nets

We can distribute bed nets once a year for two years, changing the
characteristics of the bed nets on each distribution...

```{r}
bednetparams <- simparams

bednet_events = data.frame(
  timestep = c(1, 2) * year,
  name=c("Bednets 1", "Bednets 2")
)

bednetparams <- set_bednets(
  bednetparams,
  timesteps = bednet_events$timestep,
  coverages = c(.8, .8),
  retention = 5 * year,
  dn0 = matrix(c(.533, .45), nrow=2, ncol=3),
  rn = matrix(c(.56, .5), nrow=2, ncol=3),
  rnm = matrix(c(.24, .24), nrow=2, ncol=3),
  gamman = rep(2.64 * 365, 2)
)

output <- run_simulation(sim_length, bednetparams)

add_intervention_lines(plot_prevalence(output), bednet_events)
```

## Indoor spraying

We can do the same for IRS...

```{r}
sprayingparams <- simparams

peak <- peak_season_offset(sprayingparams)
spraying_events = data.frame(
  timestep = c(1, 2) * year + peak - 3 * month,
  name=c("Spraying 1", "Spraying 2")
)

sprayingparams <- set_spraying(
  sprayingparams,
  timesteps = spraying_events$timestep,
  coverages = rep(.8, 2),
  ls_theta = matrix(c(2.025, 2.025), nrow=2, ncol=3),
  ls_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=3),
  ks_theta = matrix(c(-2.222, -2.222), nrow=2, ncol=3),
  ks_gamma = matrix(c(0.008, 0.008), nrow=2, ncol=3),
  ms_theta = matrix(c(-1.232, -1.232), nrow=2, ncol=3),
  ms_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=3)
)

output <- run_simulation(sim_length, sprayingparams)

add_intervention_lines(plot_prevalence(output), spraying_events)
```


## Larval habitat management

We can do the same for LSM but individual_mosquitoes parameter must be set to FALSE. This functionality is not yet operatable for the individual mosquito version of the model.

The parameters have strict limits to try

lsm_new_eqm: a value of 1 is no change, 0 is a 50% reduction and -1 is full reduction in recruitment to adult mosquitoes from pupae.

lsm_rate_alpha: the default is 6 and it is recommended to keep this estimate fixed

lsm_rate_beta: the default is -0.2 which achieves the reduced recruitment equilibrium after about 30 days (if lsm_rate_alpha is 6). The range to try is suggested to be between -0.5(giving a week from implementation to new level of adult susceptible mosquitoes - a fraction of the number in the absence of LSM) and -0.1 (giving about 2 months between implementation and the new equilibrium)

```{r}
habitat_managementparams <- simparams

lsm_events = data.frame(
  timestep = 3 * year, ## must be a single time point
  name=c("LSM on")
)

habitat_managementparams <- set_habitat_management(
  habitat_managementparams,
  timesteps = lsm_events$timestep,
  lsm_new_eqm = matrix(0.2,nrow=1,ncol=3),
  lsm_rate_alpha = matrix(6,nrow=1,ncol=3),
  lsm_rate_beta = matrix(-0.2,nrow=1,ncol=3)
)

output <- run_simulation(sim_length, habitat_managementparams)

add_intervention_lines(plot_prevalence(output), lsm_events)
```
