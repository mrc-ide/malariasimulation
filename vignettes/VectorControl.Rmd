---
title: "Vector Control"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vector Control}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(ggplot2))
library(malariasimulation)
library(malariaEquilibrium)
library(reshape2)
```

# Parameterisation

We will set the default parameters to run the simulation from an equilibrium.

```{r}
year <- 365
month <- 30
sim_length <- 3 * year
human_population <- 1000
starting_EIR <- 50

simparams <- get_parameters(
  list(
    human_population = human_population,
    # carrying capacity parameters
    model_seasonality = TRUE, # Let's try a bi-modal model
    g0 = 0.28605,
    g = c(0.20636, -0.0740318, -0.0009293),
    h = c(0.173743, -0.0730962, -0.116019),
    # Here, we are asking for the output to contain information on severe incidence in children 2-10 years old.
    clinical_incidence_rendering_min_ages = 2*year,
    clinical_incidence_rendering_max_ages = 10*year
  )
)

simparams <- set_equilibrium(simparams, starting_EIR)
```

We can create a few plotting functions to visualise the output.
```{r}
# Plotting functions
plot_prevalence <- function(output) {
  plot(x = output$timestep, y = output$n_detect_730_3650/output$n_730_3650, type = 'l',
       xlab = 'Timestep (days)', ylab = expression(paste(italic(Pf),"PR"[2-10])),
       xaxs = "i", yaxs = "i", bty = "l")
}

add_intervention_lines <- function(plot, events) {
  plot
  abline(v = events$timestep, col = 'blue')
  text(x = events$timestep-20, y = 0.018, events$name,
       cex = 1, col = 'black', srt = 90)
}
```

Then we can run the simulation for a variety of vector control strategies:

## Bednets

We can distribute bednets once a year for two years, changing the characteristics of the bed nets on each distribution.
  
```{r}
bednetparams <- simparams

bednet_events = data.frame(
  timestep = c(1, 2) * year,       # The bednets will be distributed at the end of the first and the second year. 
  name=c("Bednets 1", "Bednets 2") # These are labels for the two distributions. 
)

bednetparams <- set_bednets(
  bednetparams,
  timesteps = bednet_events$timestep, 
  coverages = c(.8, .8),  # Each round is distributed to 80% of the population 
  retention = 5 * year, # Nets are kept on average 5 years
  dn0 = matrix(c(.533, .45), nrow=2, ncol=1), # Matrix of death probabilities for each mosquito species over time
  rn = matrix(c(.56, .5), nrow=2, ncol=1), # Matrix of repelling probabilities for each mosquito species over time
  rnm = matrix(c(.24, .24), nrow=2, ncol=1), # Matrix of minimum repelling probabilities for each mosquito species over time
  gamman = rep(2.64 * 365, 2) # Vector of bednet half-lives for each distribution timestep
)

output <- run_simulation(sim_length, bednetparams)

add_intervention_lines(plot_prevalence(output), bednet_events)
```
  

It is important to understand the difference between the input `coverages` argument of `malariasimulation::set_bednets()` and the resulting population bednet usage over time in the model. In the above example, bednets are distributed to 80% of the population at each distribution round. 
  
The average population bednet usage will be influenced by: 
* The size and frequency of distributions specified in `set_bednets()`
* The assumed net retention half life
* Correlations in the recipients of nets between rounds
  
### Visualising usage over time
```{r}
output$prop_use_net <- output$n_use_net / output$n_0_100

plot(x = output$timestep, y = output$prop_use_net, type = 'l',
       xlab = 'Timestep (days)', ylab = 'Proportion of popoulation i',
       xaxs = "i", yaxs = "i", bty = "l")
```


  
## Indoor spraying

We can do the same for IRS.

```{r}
sprayingparams <- simparams

peak <- peak_season_offset(sprayingparams)
spraying_events = data.frame(
  timestep = c(1, 2) * year + peak - 3 * month, # There is a round of IRS in the 1st and second year 3 months prior to peak transmission.
  name=c("Spraying 1", "Spraying 2") # These are labels for the two rounds of IRS 
)

sprayingparams <- set_spraying(
  sprayingparams,
  timesteps = spraying_events$timestep,
  coverages = rep(.8, 2), # # Each round covers 80% of the population 
  ls_theta = matrix(c(2.025, 2.025), nrow=2, ncol=1), # Matrix of mortality parameters
  ls_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=1), # Matrix of mortality parameters per timestep
  ks_theta = matrix(c(-2.222, -2.222), nrow=2, ncol=1), # Matrix of feeding success parameters
  ks_gamma = matrix(c(0.008, 0.008), nrow=2, ncol=1), # Matrix of feeding success parameters per timestep
  ms_theta = matrix(c(-1.232, -1.232), nrow=2, ncol=1), # Matrix of deterrence parameters
  ms_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=1) # Matrix of deterrence parameters per timestep
)

output <- run_simulation(sim_length, sprayingparams)

add_intervention_lines(plot_prevalence(output), spraying_events)
```

## Additional species 
It is possible to account for varying proportions of mosquito species in the setting you are modelling using the `set_species()` function. If you have specified more than 1 species, then the arguments for set_spraying() and set_bednets() must be populated with values for each species at each time point. 
```{r}
# Setting 3 species of mosquitoes, 25% An. arabiensis, 25% An. funestus, and 50% An. gambiae
simparams <- set_species(
  simparams, 
  species = list(arab_params, fun_params, gamb_params),
  proportions = c(0.25, 0.25, 0.5)
)

#Here we will run the same model with IRS as before, but this time with 3 species of mosquitoes. Note that now there are 3 columns for the ls_theta, ls_gamma, ks_theta, ks_gamma, ms_theta, and ms_gamma arguments. Each column corresponds to a species and each row corresponds to a timestep when a round of IRS occurred. Here, we are assuming the same values for each species for simplicity. 
sprayingparams <- simparams

peak <- peak_season_offset(sprayingparams)
spraying_events = data.frame(
  timestep = c(1, 2) * year + peak - 3 * month, # There is a round of IRS in the 1st and second year 3 months prior to peak transmission.
  name=c("Spraying 1", "Spraying 2") # These are labels for the two rounds of IRS 
)

sprayingparams <- set_spraying(
  sprayingparams,
  timesteps = spraying_events$timestep,
  coverages = rep(.8, 2), # # Each round covers 80% of the population 
  ls_theta = matrix(c(2.025, 2.025), nrow=2, ncol=3), # Matrix of mortality parameters
  ls_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=3), # Matrix of mortality parameters per timestep
  ks_theta = matrix(c(-2.222, -2.222), nrow=2, ncol=3), # Matrix of feeding success parameters
  ks_gamma = matrix(c(0.008, 0.008), nrow=2, ncol=3), # Matrix of feeding success parameters per timestep
  ms_theta = matrix(c(-1.232, -1.232), nrow=2, ncol=3), # Matrix of deterrence parameters
  ms_gamma = matrix(c(-0.009, -0.009), nrow=2, ncol=3) # Matrix of deterrence parameters per timestep
)

output <- run_simulation(sim_length, sprayingparams)

add_intervention_lines(plot_prevalence(output), spraying_events)
```


## Using the `netz` package
The [`netz` package](https://mrc-ide.github.io/netz/index.html) is a useful tool to help set up bednets in `malariasimulation`. `malariasimulation` takes as input the proportion of the population who were distributed a bednet at specific time points, but the available data do not always have this information. `netz` allows for simple conversions between bednet metrics.  
```{r}

```

