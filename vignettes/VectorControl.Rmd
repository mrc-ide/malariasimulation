---
title: "Vector Control: Bednets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vector Control: Bednets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(malariasimulation)
library(malariaEquilibrium)
```

Long-lasting insecticidal bednets are highly effective and relatively cheap interventions to prevent malaria. They can be incorporated into `malariasimulation` with various timings and coverage and in settings with specified proportions of mosquito species. We will illustrate this through an example of  

### Parameterisation

Set the default parameters to run the simulation from an equilibrium.

```{r}
year <- 365
month <- 30
sim_length <- 3 * year
human_population <- 1000
starting_EIR <- 50

simparams <- get_parameters(
  list(
    human_population = human_population,
    # carrying capacity parameters
    model_seasonality = TRUE, # Let's try a bi-modal model
    g0 = 0.28605,
    g = c(0.20636, -0.0740318, -0.0009293),
    h = c(0.173743, -0.0730962, -0.116019),
    # Here, we are asking for the output to contain information on severe incidence in children 2-10 years old.
    clinical_incidence_rendering_min_ages = 2*year,
    clinical_incidence_rendering_max_ages = 10*year
  )
)

simparams <- set_equilibrium(simparams, starting_EIR)

output_control <- run_simulation(sim_length, simparams)
```

### Plotting functions
We can create a few plotting functions to visualise the output.
```{r}
cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# Plotting functions
plot_prev <- function() {
  plot(x = output$timestep, y = output$n_detect_730_3650/output$n_730_3650, 
       type = 'l', col = cols[4], lwd = 2.5,
       xlab = 'Time (days)', ylab = expression(paste(italic(Pf),"PR"[2-10])),
       xaxs = "i", yaxs = "i", bty = "l", ylim = c(0.15, 0.93))
  lines(x = output_control$timestep, y = output_control$n_detect_730_3650/output_control$n_730_3650,
        col = cols[6], lwd = 2.5)
  abline(v = bednetstimesteps, col = cols[1], lty = 2, lwd = 2.5)
  grid(lty = 2, col = 'grey80', lwd = 1)
  legend('topright', box.lty = 0, legend = c('Bednets','Prevalence for bednet scenario','Prevalence for control scenario'),
         col = c(cols[1], cols[4], cols[6]), lty = c(2,1,1), lwd = 2.5)
}
```

## Adding bednets

Then we can run the simulation for a variety of bednet strategies. In the example below, we distribute bednets once a year for two years, the first round to 80% of teh population and the second round to 50% of the population. It is possible to change the characteristics of the bednets for each distribution timestep by modifying the values in the matrices for `dn0`, `rn`, `rnm`, and `gamman`.
  
```{r, fig.align='center', fig.height=4, fig.width=6}
bednetparams <- simparams

bednetstimesteps <- c(1, 2) * year       # The bednets will be distributed at the end of the first and the second year. 

bednetparams <- set_bednets(
  bednetparams,
  timesteps = bednetstimesteps,
  coverages = c(.8, .5),  # The first round is distributed to 80% of the population and the second round to 50%.
  retention = 5 * year, # Nets are kept on average 5 years
  dn0 = matrix(c(.533, .45), nrow=2, ncol=1), # Matrix of death probabilities for each mosquito species over time
  rn = matrix(c(.56, .5), nrow=2, ncol=1), # Matrix of repelling probabilities for each mosquito species over time
  rnm = matrix(c(.24, .24), nrow=2, ncol=1), # Matrix of minimum repelling probabilities for each mosquito species over time
  gamman = rep(2.64 * 365, 2) # Vector of bednet half-lives for each distribution timestep
)

output <- run_simulation(sim_length, bednetparams)

plot_prev()
```
  
## Visualising bednet usage 

It is important to understand the difference between the input `coverages` argument of `malariasimulation::set_bednets()` and the resulting population bednet usage over time in the model. In the above example, bednets are distributed to a specified percentage of the population at each distribution round; however, the level of bednet usage may be different. 
  
The average population bednet usage will be influenced by:   

* The size and frequency of distributions specified in `set_bednets()`  
* The assumed net retention half life  
* Correlations in the recipients of nets between rounds  
  
The output from `malariasimulation::run_simulation()` has a variable `n_use_net` that shows the number of people using bednets at any given timestep. We can visualise the proportion of the population using bednets over time to understand how bednet usage changes. 

```{r, fig.align='center', fig.height=4, fig.width=6}
output$prop_use_net <- output$n_use_net / human_population

plot(x = output$timestep, y = output$prop_use_net, type = 'l', 
     col = cols[4], lwd = 2.5,
     xlab = 'Timestep (days)', ylab = 'Proportion of population using bednets',
     xaxs = "i", yaxs = "i", bty = "l")
grid(lty = 2, col = 'grey80', lwd = 1)
```
  
## Using the `netz` package to estimate coverage inputs needed to achieve target population usage

The [`netz` package](https://mrc-ide.github.io/netz/index.html) is a useful tool to help set up bednets in `malariasimulation`. `malariasimulation` takes as input the proportion of the population who were distributed a bednet at specific time points, but available data for a specific region or country do not always have this information. `netz` allows for simple conversions between bednet metrics like crop, access, distribution, and usage.  
  
See the vignettes from the `netz` package that explain these concepts more comprehensively:  
  
* [This vignette](https://mrc-ide.github.io/netz/articles/overview.html) explains how to estimate the distribution coverage from a specified bednet usage.   
* [This vignette](https://mrc-ide.github.io/netz/articles/population_usage.html) demonstrates how to estimate population bednet usage from an input distribution. 

